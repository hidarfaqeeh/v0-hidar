"""
Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
Telegram Webhook Handler
"""

from http.server import BaseHTTPRequestHandler
import json
import os
import asyncio
import logging
from telegram import Update, Bot
from telegram.ext import Application, CommandHandler, MessageHandler, filters

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class handler(BaseHTTPRequestHandler):
    def do_POST(self):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ Ù…Ù† ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…"""
        try:
            # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            content_length = int(self.headers.get('Content-Length', 0))
            if content_length == 0:
                self.send_error(400, "No data received")
                return
                
            post_data = self.rfile.read(content_length)
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© JSON
            try:
                update_data = json.loads(post_data.decode('utf-8'))
            except json.JSONDecodeError:
                self.send_error(400, "Invalid JSON")
                return
            
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«
            asyncio.run(self.process_telegram_update(update_data))
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù†Ø¬Ø§Ø­
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            
            response = {"status": "ok"}
            self.wfile.write(json.dumps(response).encode('utf-8'))
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ: {e}")
            
            self.send_response(500)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            
            response = {"status": "error", "message": str(e)}
            self.wfile.write(json.dumps(response).encode('utf-8'))
    
    async def process_telegram_update(self, update_data):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ø¯ÙŠØ« Ù…Ù† ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…"""
        try:
            bot_token = os.getenv('BOT_TOKEN')
            if not bot_token:
                raise ValueError("BOT_TOKEN ØºÙŠØ± Ù…Ø­Ø¯Ø¯ ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©")
            
            # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            application = Application.builder().token(bot_token).build()
            
            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
            application.add_handler(CommandHandler("start", self.start_command))
            application.add_handler(CommandHandler("help", self.help_command))
            application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_message))
            
            # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† Update
            update = Update.de_json(update_data, application.bot)
            
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«
            await application.process_update(update)
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«: {e}")
            raise
    
    async def start_command(self, update, context):
        """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± /start"""
        welcome_message = """
ğŸ¤– Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¨ÙˆØª!

Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Vercel ÙˆÙŠÙ…ÙƒÙ†Ù‡:
â€¢ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
â€¢ Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…
â€¢ ÙˆØ§Ù„Ù…Ø²ÙŠØ¯...

Ø§Ø³ØªØ®Ø¯Ù… /help Ù„Ø±Ø¤ÙŠØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©.
        """
        await update.message.reply_text(welcome_message.strip())
    
    async def help_command(self, update, context):
        """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± /help"""
        help_message = """
ğŸ“‹ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:

/start - Ø¨Ø¯Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª
/help - Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
/status - Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª

ğŸ”§ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±:
â€¢ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
â€¢ Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…
        """
        await update.message.reply_text(help_message.strip())
    
    async def handle_message(self, update, context):
        """Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©"""
        user_message = update.message.text
        response = f"ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„ØªÙƒ: {user_message}\n\nğŸ”„ Ø§Ù„Ø¨ÙˆØª Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±..."
        await update.message.reply_text(response)
